<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2021-present Kaleidos Ventures SL
-->
<ng-container *transloco="let t">
  <ng-container *ngIf="model$ | async as vm">
    <a
      [href]="
        '/project/' +
        vm.project.id +
        '/' +
        vm.project.slug +
        '/stories/' +
        story.ref
      "
      (click)="openStory($event)"
      [attr.aria-label]="
        !vm.isA11yDragInProgress
          ? t('kanban.story_title_a11y', {
              ref: story.ref,
              title: story.title,
              position: index + 1,
              total: total
            })
          : null
      "
      class="story-kanban-ref-focus">
      <div class="story-title">
        <div class="draggable-icon">
          <tui-svg src="draggable"></tui-svg>
        </div>
        <div class="ref">{{ story.ref }}</div>
        <div class="text">{{ story.title }}</div>
      </div>
      <div class="story-body">
        <ng-container
          *hasPermission="
            ['modify'];
            entity: 'story';
            else: noAssignPermissionsTpl
          ">
          <div
            class="assign-user"
            [tuiDropdown]="assignUser"
            [tuiDropdownMinHeight]="272"
            [tuiDropdownMaxHeight]="530"
            [tuiDropdownOffset]="-30"
            [tuiDropdownManual]="vm.showAssignUser"
            (tuiActiveZoneChange)="onAssignUserActiveZoneChange($event)">
            <button
              (click)="toggleAssignUser($event)"
              (focus)="displayHintAssignUser()"
              (focusout)="displayHintAssignUser()"
              (mouseenter)="displayHintAssignUser()"
              (mouseleave)="displayHintAssignUser()"
              [tuiHintManual]="hintAssignUser"
              [tuiHint]="!vm.assignees.length ? unassignedTooltip : null"
              [tuiHintDirection]="'bottom-right'"
              [ngClass]="{
                'unassigned-button-perm': !vm.assignees.length,
                'assigned-button-perm': vm.assignees.length
              }">
              <ng-container
                [ngTemplateOutlet]="
                  vm.assignees.length ? displayUsersTpl : assignBtnTpl
                "
                [ngTemplateOutletContext]="{
                  $implicit: 'assignPermissions'
                }"></ng-container>
            </button>
          </div>
        </ng-container>
      </div>
    </a>

    <!-- Assigned users temaplate -->

    <ng-template
      #displayUsersTpl
      let-permissions>
      <div
        class="assigned-users-list"
        [attr.aria-label]="
          permissions === 'assignPermissions'
            ? t('kanban.story_card.assigned_list_perm', {
                users: assignedListA11y
              })
            : t('kanban.story_card.assigned_list', {
                users: assignedListA11y
              })
        ">
        <tg-user-avatar
          *ngFor="
            let assigned of reversedAssignees | slice: -3;
            trackBy: trackByIndex
          "
          size="m"
          class="assigned-user-avatar"
          [color]="assigned.color"
          [user]="assigned"
          type="light"
          [rounded]="true"
          aria-hidden="true"
          [tuiHint]="assigned.fullName"
          [tuiHintDirection]="'bottom-right'"></tg-user-avatar>
      </div>
      <div
        class="assigned-user-avatar-extra"
        aria-hidden="true"
        *ngIf="vm.assignees.length > 3"
        [tuiHint]="moreAssignedTooltip"
        [tuiHintDirection]="'bottom-right'">
        {{ restAssigneesLenght }}
      </div>
    </ng-template>

    <!-- Assign button template - user with permissions -->

    <ng-template #assignBtnTpl>
      <div [attr.aria-label]="t('kanban.story_card.unassigned_action')">
        {{ t('kanban.story_card.assign') }}
      </div>
    </ng-template>

    <!-- Assign button template - user with permissions -->

    <ng-template #assignUser>
      <tg-assign-user
        [assigned]="vm.assignees"
        [viewOnly]="!vm.canEdit"
        [ref]="story.ref"
        (assign)="assign($event)"
        (unassign)="unassign($event)"
        (requestClose)="closeAssignDropdown()"></tg-assign-user>
    </ng-template>

    <!-- Assign elements - no permissions -->

    <ng-template #noAssignPermissionsTpl>
      <div
        *ngIf="!vm.assignees.length"
        [tuiHint]="unassignedTooltip"
        [tuiHintDirection]="'bottom-right'"
        class="unassigned-button-noperm"
        aria-labelledby="unassigned-tooltip">
        {{ t('kanban.story_card.unassigned') }}
      </div>
      <div
        *ngIf="vm.assignees.length"
        [tuiDropdown]="assignUser"
        [tuiDropdownMinHeight]="272"
        [tuiDropdownMaxHeight]="530"
        [tuiDropdownOffset]="-30"
        [tuiDropdownManual]="vm.showAssignUser"
        (tuiActiveZoneChange)="onAssignUserActiveZoneChange($event)"
        class="assigned-button-noperm">
        <button
          (click)="toggleAssignUser($event)"
          [ngClass]="{
            'assigned-button-perm': vm.assignees.length
          }">
          <ng-container
            [ngTemplateOutlet]="displayUsersTpl"
            [ngTemplateOutletContext]="{
              $implicit: 'noAssignPermissions'
            }"></ng-container>
        </button>
      </div>
    </ng-template>

    <ng-template #unassignedTooltip>
      <p
        id="unassigned-tooltip"
        aria-hidden="true">
        {{ t('kanban.story_card.story_not_assigned') }}
      </p>
    </ng-template>

    <ng-template #moreAssignedTooltip>
      <p
        id="more-assigned-tooltip"
        aria-hidden="true">
        {{
          t('kanban.story_card.more_assigned', {
            assigneesNum: vm.assignees.length - 3
          })
        }}
      </p>
    </ng-template>
  </ng-container>
</ng-container>
