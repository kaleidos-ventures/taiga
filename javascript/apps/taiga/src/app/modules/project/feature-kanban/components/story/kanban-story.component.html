<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2021-present Kaleidos Ventures SL
-->
<ng-container *transloco="let t">
  <ng-container *ngIf="model$ | async as vm">
    <a
      [href]="
        '/project/' +
        vm.project.id +
        '/' +
        vm.project.slug +
        '/stories/' +
        story.ref
      "
      (click)="openStory($event)"
      [attr.aria-label]="
        !vm.isA11yDragInProgress
          ? t('kanban.story_title_a11y', {
              ref: story.ref,
              title: story.title,
              position: index + 1,
              total: total
            })
          : null
      "
      class="story-kanban-ref-focus">
      <div class="story-title">
        <div class="draggable-icon">
          <tui-svg src="draggable"></tui-svg>
        </div>
        <div class="ref">{{ story.ref }}</div>
        <div class="text">{{ story.title }}</div>
      </div>
      <div class="story-body">
        <ng-container
          *hasPermission="
            ['modify'];
            entity: 'story';
            else: noAssignPermissionsTpl
          ">
          <div
            class="assign-user"
            [tuiDropdown]="assignUser"
            [tuiDropdownMinHeight]="272"
            [tuiDropdownMaxHeight]="530"
            [tuiDropdownManual]="vm.showAssignUser"
            (tuiActiveZoneChange)="onAssignUserActiveZoneChange($event)">
            <button
              (click)="toggleAssignUser($event)"
              [tuiHint]="!assignedUsers.length ? tooltip : null"
              [tuiHintDirection]="'bottom-right'"
              [ngClass]="{
                'unassigned-button-perm': !assignedUsers.length,
                'assigned-button': assignedUsers.length
              }">
              <ng-template
                *ngIf="
                  assignedUsers.length;
                  then displayUsersTpl;
                  else assignBtnTpl
                ">
              </ng-template>
              <ng-template #displayUsersTpl>Display users</ng-template>
              <ng-template #assignBtnTpl>
                <div [attr.aria-label]="t('kanban.story_card.assign_key')">
                  {{ t('kanban.story_card.assign') }}
                </div>
              </ng-template>
            </button>
          </div>
        </ng-container>
      </div>
    </a>

    <ng-template #assignUser>
      <tg-assign-user
        [assigned]="story.assignedTo"
        (assign)="assign($event)"
        (unassign)="unassign($event)"
        (requestClose)="closeAssignDropdown()"></tg-assign-user>
    </ng-template>
  </ng-container>

  <ng-template #noAssignPermissionsTpl>
    <div
      *ngIf="!assignedUsers.length"
      [tuiHint]="tooltip"
      [tuiHintDirection]="'bottom-right'"
      class="unassigned-button-noperm"
      aria-labelledby="unassigned-tooltip">
      {{ t('kanban.story_card.unassigned') }}
    </div>
    <div
      *ngIf="assignedUsers.length"
      class="assigned-button-noperm">
      assigned
    </div>
  </ng-template>

  <ng-template #tooltip>
    <p
      id="unassigned-tooltip"
      aria-hidden="true">
      {{ t('kanban.story_card.story_not_assigned') }}
    </p>
  </ng-template>
</ng-container>
