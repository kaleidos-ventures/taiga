<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2023-present Kaleidos INC
-->

<ng-container *ngIf="model$ | async as vm">
  <ng-container *transloco="let t">
    <tg-workspace-detail-skeleton *ngIf="!vm.workspace">
    </tg-workspace-detail-skeleton>
    <ng-container *ngIf="vm.workspace">
      <div class="workspace-detail-top">
        <div class="workspace-detail-avatar">
          <tg-ui-avatar
            class="workspace-avatar"
            type="dark"
            [color]="vm.workspace.color"
            size="xl"
            [name]="vm.workspace.name">
          </tg-ui-avatar>
        </div>
        <div class="workspace-detail-name-wrapper">
          <div class="workspace-detail-name-route">
            {{ t('commons.workspace') }}/
          </div>
          <div class="workspace-detail-name-container">
            <h2
              [attr.aria-label]="
                t('workspace.a11y.workspace_title', {
                  workspace: vm.workspace.name,
                  role: t('commons.roles.' + vm.workspace.userRole)
                })
              "
              data-test="workspace-detail-name"
              class="workspace-detail-name"
              tgTitle>
              {{ vm.workspace.name }}
            </h2>
            <tg-ui-badge
              *ngIf="vm.workspace.userRole"
              [label]="t('commons.roles.' + vm.workspace.userRole) | capitalize"
              size="s"
              [color]="vm.workspace.userRole === 'guest' ? 'gray' : 'info'">
            </tg-ui-badge>
            <tui-hosted-dropdown
              *ngIf="vm.workspace.userRole === 'admin'"
              [tuiDropdownAlign]="'left'"
              [content]="workspaceOptions"
              [(open)]="displayWorkspaceOptions">
              <button
                class="display-workspace-options"
                role="menu"
                aria-haspopup="true"
                [attr.aria-expanded]="displayWorkspaceOptions"
                tabindex="0"
                [attr.aria-label]="t('workspace.workspace_options')"
                icon="more-vertical"
                data-test="workspace-options"
                appearance="tertiary"
                tuiIconButton
                type="button"
                [tuiHint]="t('workspace.workspace_actions')"
                (click)="(displayWorkspaceOptionsModal)"></button>
            </tui-hosted-dropdown>
          </div>
        </div>
        <div class="workspace-detail-back">
          <a
            tuiButton
            type="button"
            appearance="tertiary"
            [routerLink]="['/']"
            iconRight="arrow-right">
            {{ t('workspace.back_to_projects') }}
          </a>
        </div>
      </div>
      <div
        *ngIf="
          (loading$ | async) === false &&
          !vm.workspace.totalProjects &&
          !vm.invitations.length &&
          vm.workspace.hasProjects &&
          vm.workspace.userRole !== 'admin' &&
          !vm.creatingWorkspaceDetail
        "
        class="workspace-message-placeholder detail"
        [innerHtml]="t('workspace.placehoder_no_access')"></div>
      <div
        *ngIf="
          (loading$ | async) === false &&
          !vm.workspace.totalProjects &&
          !vm.invitations.length &&
          !vm.workspace.hasProjects &&
          vm.workspace.userRole !== 'admin' &&
          !vm.creatingWorkspaceDetail
        "
        class="workspace-message-placeholder detail"
        [innerHtml]="t('workspace.placehoder_no_projects')"></div>
      <div
        [@.disabled]="animationDisabled"
        (resized)="onResized($event)"
        [class]="gridClass"
        class="workspace-item-card-grid">
        <div
          *ngIf="
            vm.projects.length === 0 &&
            vm.workspace.userRole === 'admin' &&
            !vm.creatingWorkspaceDetail
          ">
          <tg-project-card
            (projectToDelete)="setProjectToDelete($event)"
            (openModal)="openModal($event)"
            [workspace]="vm.workspace"
            [hasActions]="true"
            variant="placeholder"
            [firstProject]="true">
          </tg-project-card>
        </div>
        <div
          *ngFor="
            let invitation of vm.invitations;
            trackBy: trackByLatestProject
          "
          [@cardSlideOut]="vm.slideOutActive ? 'on' : 'off'"
          (@cardSlideOut.done)="slideOutAnimationDone($event)"
          [@newProject]="
            vm.newInvitations.includes(invitation.id) ? 'inprogress' : 'idle'
          "
          (@newProject.start)="newProjectAnimationStart($event, invitation)"
          (@newProject.done)="newProjectAnimationDone($event)"
          [@newInvitationSibling]="
            vm.projectSiblingToAnimate.includes(invitation.id)
              ? 'inprogress'
              : 'idle'
          "
          [@reorder]="reorder[invitation.id]"
          (@reorder.done)="reorderDone($event)">
          <tg-project-card
            (projectToDelete)="setProjectToDelete($event)"
            (openModal)="openModal($event)"
            variant="invitation"
            (rejectInvite)="rejectProjectInvite($event)"
            (acceptInvite)="acceptProjectInvite($event.id, $event.name)"
            [hasActions]="true"
            [workspace]="vm.workspace"
            [project]="invitation">
          </tg-project-card>
        </div>
        <ng-container *ngIf="vm.creatingWorkspaceDetail">
          <div
            *ngFor="
              let _ of [].constructor(amountOfProjectsToShow);
              trackBy: trackByIndex
            ">
            <tg-ui-card-skeleton></tg-ui-card-skeleton>
          </div>
        </ng-container>
        <div
          *ngFor="let project of vm.projects; trackBy: trackByLatestProject"
          [@newProject]="
            newProjectsToAnimate.includes(project.id) ? 'inprogress' : 'idle'
          "
          (@newProject.start)="newProjectAnimationStart($event, project)"
          (@newProject.done)="newProjectAnimationDone($event)"
          [@newInvitationSibling]="
            vm.projectSiblingToAnimate.includes(project.id)
              ? 'inprogress'
              : 'idle'
          "
          [@reorder]="reorder[project.id]"
          (@reorder.done)="reorderDone($event)">
          <tg-project-card
            (projectToDelete)="setProjectToDelete($event)"
            (openModal)="openModal($event)"
            [hasActions]="true"
            [project]="project"
            [workspace]="vm.workspace">
          </tg-project-card>
        </div>
        <div
          *ngIf="vm.projects.length > 0 && vm.workspace.userRole === 'admin'">
          <tg-project-card
            (projectToDelete)="setProjectToDelete($event)"
            (openModal)="openModal($event)"
            [hasActions]="true"
            [workspace]="vm.workspace"
            variant="placeholder">
          </tg-project-card>
        </div>
      </div>
      <ng-template #workspaceOptions>
        <tui-data-list
          class="workspace-options-list"
          data-test="workspace-options-list"
          [attr.aria-label]="t('workspace.workspace_options')">
          <button
            role="menuitem"
            data-test="edit-ws-button"
            class="ws-option"
            tuiOption
            type="button"
            (click)="editWorkspaceModal()">
            <tui-svg
              aria-hidden="true"
              class="ws-option-icon"
              src="pen"></tui-svg>
            <span class="ws-option-name">{{
              t('workspace.edit_workspace_name')
            }}</span>
          </button>
          <hr class="separator" />
          <button
            class="ws-option delete"
            role="menuitem"
            data-test="delete-ws-button"
            tuiOption
            type="button"
            (click)="handleDeleteWorkspace()">
            <tui-svg
              class="ws-option-icon"
              aria-hidden="true"
              src="trash"></tui-svg>
            <span class="ws-option-name delete">{{
              t('workspace.delete.delete_workspace')
            }}</span>
          </button>
        </tui-data-list>
      </ng-template>
      <tg-workspace-detail-edit-modal
        *ngIf="vm.editingWorkspace"
        [workspace]="vm.workspace"
        [open]="vm.editingWorkspace"
        (update)="updateWorkspace($event)"
        (cancelEdit)="closeEditWorkspaceModal()">
      </tg-workspace-detail-edit-modal>
      <tg-delete-workspace
        *ngIf="showDeleteWorkspaceModal"
        [show]="showDeleteWorkspaceModal"
        (closeModal)="showDeleteWorkspaceModal = false"
        [projects]="vm.workspace.totalProjects"></tg-delete-workspace>
    </ng-container>
  </ng-container>

  <tg-delete-project
    *ngIf="deleteProjectModal"
    [show]="deleteProjectModal"
    (submitDelete)="submitDeleteProject()"
    (closeModal)="deleteProjectModal = false"
    [project]="projectToDelete">
  </tg-delete-project>
</ng-container>
