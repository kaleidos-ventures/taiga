<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2021-present Kaleidos Ventures SL
-->

<ng-container *transloco="let t">
  <div class="wrapper">
    <h1 class="modal-title">
      {{ t('invitation_modal.title', { project: project.name }) }}
    </h1>
    <form
      class="form-container"
      [formGroup]="inviteProjectForm">
      <tui-scrollbar class="padding-scroll">
        <p
          class="text"
          [innerHtml]="t('invitation_modal.instructions')"></p>
        <p
          class="text"
          [innerHtml]="t('invitation_modal.alternative')"></p>
        <div class="add-wrapper">
          <tui-svg
            class="add-icon"
            src="user"
            aria-hidden="true"></tui-svg>
          <div
            class="text-area"
            #textArea>
            <tg-ui-textarea>
              <tui-text-area
                class="invitation-textarea compressed"
                #emailInput
                tuiAutoFocus
                data-test="input-add-invites"
                [class.bottom-space]="
                  (emailsWithoutDuplications$ | async)!.length > 1
                "
                [class.invalid]="
                  inviteIdentifierErrors.required ||
                  inviteIdentifierErrors.regex ||
                  inviteIdentifierErrors.peopleNotAdded ||
                  inviteIdentifierErrors.bulkError
                "
                tuiTextfieldSize="s"
                [(ngModel)]="inviteIdentifier"
                (ngModelChange)="searchChange($event)"
                [ngModelOptions]="{ standalone: true }"
                [expandable]="true"
                [rows]="12"
                [tuiDropdownContent]="dropdownContent"
                [tuiDropdown]="inviteIdentifier.length > 1 && notInBulkMode"
                (focusedChange)="updateEmailInputIsFocus(true)"
                (tuiActiveZoneChange)="onActiveZone($event)"
                (click)="$event.stopPropagation()"
                (keydown.arrowUp)="handleArrow('up')"
                (keydown.arrowDown)="handleArrow('down')"
                (keydown.enter)="
                  suggestionContactsDropdownActivate
                    ? includeSuggestedContact(suggestionSelected, $event)
                    : null
                ">
                {{ t('invitation_modal.placeholder') }}
              </tui-text-area>
              <tg-ui-error
                data-test="error-add-email"
                inputError
                [show]="inviteIdentifierErrors.required">
                {{ t('invitation_modal.error_add_email') }}
              </tg-ui-error>
              <tg-ui-error
                data-test="error-regex"
                inputError
                [show]="inviteIdentifierErrors.regex">
                {{ t('invitation_modal.error_email_regex') }}
              </tg-ui-error>
              <tg-ui-error
                data-test="error-missing-people"
                inputError
                [show]="inviteIdentifierErrors.peopleNotAdded">
                {{ t('invitation_modal.error_missing_people') }}
              </tg-ui-error>
              <tg-ui-error
                inputError
                [show]="inviteIdentifierErrors.bulkError">
                {{ t('invitation_modal.error_several_emails') }}
              </tg-ui-error>
            </tg-ui-textarea>
            <ng-container
              *ngIf="
                emailsWithoutDuplications$ | async as emailsWithoutDuplications
              ">
              <span
                data-test="email-count"
                *ngIf="emailsWithoutDuplications.length > 1"
                class="emails-count"
                [class.errors]="emailsHaveErrors"
                >{{
                  t('invitation_modal.emails_detected', {
                    emails: emailsWithoutDuplications.length
                  })
                }}</span
              >
            </ng-container>
            <ng-template #dropdownContent>
              <ng-container *ngIf="searchInProgress$ | async">
                <ng-container
                  *ngIf="
                    inviteIdentifier.length > 1 &&
                    notInBulkMode &&
                    emailInputIsFocus
                  ">
                  <tui-data-list
                    id="suggestions"
                    role="listbox"
                    data-test="suggestions-list"
                    [emptyContent]="t('invitation_modal.no_results')">
                    <ng-container
                      *ngIf="suggestedUsers$ | async as suggestedUsers">
                      <button
                        *ngFor="
                          let contact of suggestedUsers;
                          index as i;
                          trackBy: trackByIndex
                        "
                        tuiOption
                        role="option"
                        class="suggested-btn"
                        data-test="option"
                        [attr.id]="'suggestion-' + i"
                        [disabled]="
                          !!contact.userIsMember || !!contact.userIsAddedToList
                        "
                        [class.selected]="
                          suggestionSelected === i &&
                          !contact.userIsMember &&
                          !contact.userIsAddedToList
                        "
                        [attr.aria-disabled]="
                          suggestionSelected !== i ||
                          !!contact.userIsMember ||
                          !!contact.userIsAddedToList
                        "
                        [attr.aria-selected]="suggestionSelected === i"
                        (click)="includeSuggestedContact(i, $event)">
                        <tg-user-card
                          [user]="contact"
                          [disabled]="
                            !!contact.userIsMember || !!contact.userIsAddedToList
                          "
                          [active]="suggestionSelected === i"
                          [textToHighlight]="
                            parseTextToHighlight
                          "></tg-user-card>
                        <tg-ui-badge
                          *ngIf="contact.userIsMember"
                          data-test="info-user"
                          class="disabled-badge"
                          [label]="
                            t('invitation_modal.already_member')
                          "></tg-ui-badge>
                        <tg-ui-badge
                          *ngIf="contact.userIsAddedToList"
                          data-test="info-user"
                          class="disabled-badge"
                          [label]="
                            t('invitation_modal.already_on_list')
                          "></tg-ui-badge>
                      </button>
                    </ng-container>
                  </tui-data-list>
                </ng-container>
              </ng-container>
            </ng-template>
          </div>

          <button
            data-test="add-invites"
            class="add-btn"
            appearance="primary"
            tuiButton
            (click)="addUser()"
            type="button">
            {{ t('invitation_modal.add') }}
          </button>
        </div>

        <ng-container *ngIf="users.length === 0">
          <div
            class="tip-wrapper"
            data-test="tip-wrapper">
            <tui-svg
              class="tip-icon"
              src="/assets/images/curved-arrow.svg"
              aria-hidden="true"></tui-svg>
            <p class="tip">{{ t('invitation_modal.add_people') }}</p>
          </div>
        </ng-container>

        <div
          *ngIf="users.length"
          class="user-list"
          data-test="user-list">
          <div class="user">
            <span></span>
            <span class="user-title">{{
              t('invitation_modal.name_email')
            }}</span>
            <span class="user-title">{{ t('invitation_modal.role') }}</span>
            <span></span>
          </div>

          <ng-container
            *ngFor="let user of users; index as i; trackBy: trackByIndex">
            <ng-container *ngIf="memberRoles$ | async as memberRoles">
              <tg-user-to-invite
                [user]="user"
                [userIndex]="i"
                [roles]="memberRoles"
                [isPending]="isPending(user.get('username')?.value)"
                (delete)="deleteUser($event)"></tg-user-to-invite>
            </ng-container>
          </ng-container>
        </div>
      </tui-scrollbar>
      <div class="actions-wrapper">
        <tg-ui-context-notification
          *ngIf="inviteIdentifierErrors.listEmpty"
          data-test="error-at-lest-one"
          alertLevel="polite"
          class="notification"
          status="error">
          {{ t('invitation_modal.error_add_least_one') }}
        </tg-ui-context-notification>
        <tg-ui-context-notification
          *ngIf="inviteIdentifierErrors.moreThanFifty && users.length > 50"
          class="notification"
          status="error"
          [hasIcon]="true">
          {{
            t('invitation_modal.error_more_than_fifty', {
              invitations: users.length - 50
            })
          }}
        </tg-ui-context-notification>
        <div class="form-actions">
          <button
            tuiLink
            (click)="close()"
            appearance="tertiary"
            data-test="close-modal">
            {{
              fromOverview
                ? t('invitation_modal.close')
                : t('invitation_modal.later')
            }}
          </button>
          <button
            loading
            [loadingMsg]="t('invitation_modal.send_invites_in_progress')"
            [loadingSuccess]="t('invitation_modal.send_invites_success')"
            appearance="primary"
            data-test="submit-invite-users"
            tuiButton
            (click)="sendForm()"
            type="button">
            {{ t('invitation_modal.send_invites') }}
          </button>
        </div>
      </div>
    </form>
  </div>
</ng-container>
