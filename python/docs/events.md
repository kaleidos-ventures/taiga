# Events

Taiga offers one endpoint that expose a websocket connection to receive all the events generated by the user interactions with the API. This endpoint is at `/events/`:

```
ws://localhost:8000/events/        # Example for a development environment
wss://taiga.domain.com/events/     # Example for a taiga api instance with SSL
```

## Actions:

### `ping`

- Request:
  ```json
  {
      "command": "ping"
  }
  ```
- Response:
  ```json
  {
      "type": "action",
      "action": {
          "command": "ping"
      },
      "status": "ok",
      "content": {
          "message": "pong"
      }
  }
  ```


### `signin`

- Request:
  ```json
  {
      "command": "signin",
      "token": "some-valid-auth-token"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signin",
          "token": "some-valid-auth-token"
      },
      "status": "ok",
      "content": {
          "channel": "users.username"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signin"
          "token": "some-invalid-auth-token"
      },
      "status": "error",
      "content": {
          "detail": "invalid-credentials"
      }
  }
  ```

### `signout`

- Request:
  ```json
  {
      "command": "signout"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signout"
      },
      "status": "ok",
      "content": {}
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signout"
      },
      "status": "error",
      "content": {
          "detail": "not-signed-in"
      }
  }
  ```

### `subscribe_to_project_events`

- Request:
  ```json
  {
      "command": "subscribe_to_project_events",
      "project": "<project_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_project_events",
          "project": "<project_id>"
      },
      "status": "ok",
      "content": {
          "channel": "projects.<project_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_project_events",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `unsubscribe_from_project_events`

- Request:
  ```json
  {
        "command": "unsubscribe_from_project_events",
        "project": "<project_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_project_events",
          "project": "<project_id>"
      },
      "status": "ok",
      "content": {
          "channel": "projects.<project_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_project_events",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-subscribed"
      }
  }
  ```
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_project_events",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `check_project_events_subscription`

- Request:
  ```json
  {
        "command": "check_project_events_subscription",
        "project": "<project_id>"
  }
  ```
- Response OK:
  ```
  no response send
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "check_project_events_subscription",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "lost-permissions"
      }
  }
  ```

### `subscribe_to_workspace_events`

- Request:
  ```json
  {
      "command": "subscribe_to_workspace_events",
      "workspace": "<workspace_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "ok",
      "content": {
          "channel": "workspaces.<workspace_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `unsubscribe_from_workspace_events`

- Request:
  ```json
  {
        "command": "unsubscribe_from_workspace_events",
        "workspace": "<workspace_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "ok",
      "content": {
          "channel": "workspaces.<workspace_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-subscribed"
      }
  }
  ```
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `check_workspace_events_subscription`

- Request:
  ```json
  {
        "command": "check_workspace_events_subscription",
        "workspace": "<workspace_id>"
  }
  ```
- Response OK:
  ```
  no response send
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "check_workspace_events_subscription",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "lost-permissions"
      }
  }
  ```

## Events

### Response

```json
{
    "type": "event",
    "channel": "<channel-name>",
    "event": {
        "type": "<event-type>",
        "content": {...},
        "correlationId": "<correlation-id value>"
    }
}
```

### Channels

- `system` - channel for brodcast important messages for all the clients. [TODO]
- `users.<username>` - channel to publish all user events.
- `projects.<project_id>` - channel to publish all the project events. [TODO]
- `workspaces.<workspace_id>` - channel to publish all the workspace events. [TODO]


### Types and content schemas

- We have common events types for C/U/D actions over the objets, the schema is:
  ```
  <object_in_plural>.["create" | "update" |"delete"]
  ```
- And for generic objets, like comments or attachments, we use:
  ```
  <module>.<object_in_plural>.["create" | "update" |"delete"]
  ```
- We may have other actions if required; for example: `projectinvitations.revoke`.
- We may also have events that affect only a subset of atributes of an object; for example `projects.permissions.update`.
- We can send actions inside an event. The type must be `action` and the content should be an action described above.

For example:

```
projects.create
projects.permissions.update
projectinvitations.revoke
stories.delete
stories.comments.delete
```

#### `workspaces.delete`

It happens when a workspace is deleted

Content for:
- workspace channel:
  ```
  {
      "workspace": "workspace_id",
      "name": "workspace name (str)",
      "deletedBy": {... basic user info ...}
  }
  ```


#### `workspacememberships.create`

It happens when a workspace invitation is accepted. Because a new workspace membership is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
  }
  ```
- workspace channel:
  ```
  null
  ```

#### `workspacesmemberships.delete`

It happens when a workspace membership is deleted

Content for:
- workspace channel:
  ```
  {
      "membership": {... "workspace membership object" ...}
  }
  ```

- user channel:
  ```
  {
      "membership": {... "workspace membership object" ...}
  }
  ```

#### `workspaceinvitations.create`

It happens when a new workspace invitation is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
  }
  ```

- workspace channel:
  ```
  null
  ```

#### `workspaceinvitations.update`

It happens when a workspace invitation is updated.

Content for:
- workspace channel:
  ```
  null
  ```

#### `workspaceinvitations.delete`

It happens when a pending workspace invitation is deleted.

Content for:
- workspace channel:
  ```
  null
  ```

#### `projects.delete`

It happens when a project is deleted

Content for:
- workspace channel:
  ```
  {
      "project": "project_id",
      "workspace": "workspace_id",
      "name": "project name (str)",
      "deletedBy": {... basic user info ...}
  }
  ```


#### `projectinvitations.create`

It happens when a new project invitation is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectinvitations.update`

It happens when one or more invitations are updated:
- the role has been changed.
- a user has verified her account.


Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectinvitations.revoke`

It happens when one invitation is revoked

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectinvitations.delete`

It happens when a pending project invitation is deleted.

Content for:
- project channel:
  ```
  null
  ```

#### `projectmemberships.create`

It happens when a project invitation is accepted. Because a new project membership is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectmemberships.create`

It happens when a project membership role is created.

Content for:
- user channel:
  ```
  {
      "membership": {... "project membership object" ...}
  }
  ```
- project channel:
  ```
  {
      "membership": {... "project membership object" ...}
  }
  ```

#### `projectmemberships.update`

It happens when a project membership role is updated.

Content for:
- user channel:
  ```
  {
      "membership": {... "project membership object" ...}
  }
  ```
- project channel:
  ```
  {
      "membership": {... "project membership object" ...}
  }
  ```

#### `projectmemberships.delete`

It happens when a project membership is deleted

Content for:
- user channel:
  ```
  {
      "membership": {... "project membership object" ...},
      "workspace": "workspace_id",
  }
  ```
- project channel:
  ```
  {
      "membership": {... "project membership object" ...},
      "workspace": "workspace_id",
  }
  ```
- workspace channel:
  ```
  {
      "membership": {... "project membership object" ...},
      "workspace": "workspace_id",
  }
  ```


#### `projectroles.update`

It happens when project role (permissions or name) is updated.

Content for:
- project channel:
  ```
  {
      ... "detailed project role object" ...
  }
  ```

#### `projects.permissions.update`

It happens when project public permissions are updated.

Content for:
- project channel:
  ```
  null
  ```


#### `workflows.create`

It happens when a new workflow has been created.

Content for:
- project channel:
  ```
  {
      "workflow": {... "workflow object" ...}
  }
  ```


#### `workflows.update`

It happens when a workflow has been updated.

Content for:
- project channel:
  ```
  {
      "workflow": {... "workflow object" ...}
  }
  ```

#### `workflows.delete`

It happens when a workflow has been deleted.

Content for:
- project channel:
  ```
  {
      "workflow": {... "workflow object" ...},
      "targetWorkflow": null | {... "workflow object" ...}
  }
  ```


#### `workflowstatuses.create`

It happens when a new workflow status has been created.

Content for:
- project channel:
  ```
  {
      "workflowStatus": {... "workflow status object" ...}
  }
  ```


#### `workflowstatuses.update`

It happens when a workflow status has been updated.

Content for:
- project channel:
  ```
  {
      "workflowStatus": {... "workflow status object" ...}
  }
  ```


#### `workflowstatuses.reorder`

It happens when some workflow statuses are reordered.

Content for:
- project channel:
  ```
  {
      "reorder": {
          "workflow": {... workflow object ...},
	      "statuses": [
		      "moved wf_status id",
		      "moved wf_status id",
              ....
	      ],
	      "reorder": {
		      "place": "'before' or 'after'",
		      "status": "worklflow status id"
	      }
      }
  }
  ```

#### `workflowstatuses.delete`

It happens when a workflow status has been deleted.

Content for:
- project channel:
  ```
  {
      "workflowStatus": {... "workflow status object" ...},
      "moveToSlug": null | "closed"
  }
  ```


#### `stories.create`

It happens when a new story has been created.

Content for:
- project channel:
  ```
  {
      "story": {... "story object" ...}
  }
  ```

#### `stories.update`

It happens when a story has been updated.

Content for:
- project channel:
  ```
  {
      "story": {... "detailed story object" ...}
      "updatesAttrs" : [
          "attr1",
          "attr2",
          ...
      ]
  }
  ```

#### `stories.reorder`

It happens when some stories are reordered.

Content for:
- project channel:
  ```
  {
      "reorder": {
          "status": {... workflow status object ...},
	      "stories": [
		      "moved story ref1 (int)",
		      "moved story ref2 (int)",
              ....
	      ],
	      "reorder": {
		      "place": "'before' or 'after'",
		      "ref": "story ref (int)"
	      }
      }
  }
  ```

#### `stories.delete`

It happens when a story has been deleted.

Content for:
- project channel:
  ```
  {
      "ref": "story ref (int)"
      "deletedBy": {... basic user info ...}
  }
  ```


#### `storiesassignments.create`

It happens when a new story assignment has been created.

Content for:
- user channel:
  ```
  {
      "storyAassignment": {... "story_assignment object" ...}
  }
  ```
- project channel:
  ```
  {
      "storyAssignment": {... "story_assignment object" ...}
  }
  ```

#### `storiesassignments.delete`

It happens when a story assignment has been deleted.

Content for:
- user channel:
  ```
  {
      "story": {... "story object" ...}
  }
  ```
- project channel:
  ```
  {
      "story": {... "story object" ...}
  }
  ```


#### `stories.comments.create`

It happens when a new comment associated to a story is created.

Content for:
- project channel:
  ```

  {
      "ref": "story ref (int)",
      "comment": {... "comment object" ...}
  }
  ```


#### `stories.comments.update`

It happens when a comment associated to a story is updated.

Content for:
- project channel:
  ```

  {
      "ref": "story ref (int)",
      "comment": {... "comment object" ...}
  }
  ```


#### `stories.comments.delete`

It happens when a comment associated to a story is deleted.

Content for:
- project channel:
  ```

  {
      "ref": "story ref (int)",
      "comment": {... "comment object" ...}
  }
  ```

#### `users.delete`

It happens when a user is deleted.

Content for:
- user channel:
  ```
  null
  ```


#### `stories.attachments.create`

It happens when a new attachment associated to a story is created.

Content for:
- project channel:
  ```

  {
      "ref": "story ref (int)",
      "attachment": {... "attachment object" ...},
  }
  ```


#### `stories.attachments.delete`

It happens when a attachment associated to a story is deleted.

Content for:
- project channel:
  ```

  {
      "ref": "story ref (int)",
      "attachment": {... "attachment object" ...}
  }
  ```


#### `notifications.create`

It happens when a new notifications is created.

Content for:
- user channel:
  ```
  {
      "notification": {... "notification object" ...},
  }
  ```


#### `notifications.read`

It happens when one or some notifications are marked as read.

Content for:
- user channel:
  ```
  {
      "notifications_ids": [
        "notification id 1",
        "notification id 2",
        ...
      ]
  }
  ```