# Events

Taiga offers one endpoint that expose a websocket connection to receive all the events generated by the user interactions with the API. This endpoint is at `/events/`:

```
ws://localhost:8000/events/        # Example for a development environment
wss://taiga.domain.com/events/     # Example for a taiga api instance with SSL
```

## Actions:

### `ping`

- Request:
  ```json
  {
      "command": "ping"
  }
  ```
- Response:
  ```json
  {
      "type": "action",
      "action": {
          "command": "ping"
      },
      "status": "ok",
      "content": {
          "message": "pong"
      }
  }
  ```


### `signin`

- Request:
  ```json
  {
      "command": "signin",
      "token": "some-valid-auth-token"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signin",
          "token": "some-valid-auth-token"
      },
      "status": "ok",
      "content": {
          "channel": "users.username"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signin"
          "token": "some-invalid-auth-token"
      },
      "status": "error",
      "content": {
          "detail": "invalid-credentials"
      }
  }
  ```

### `signout`

- Request:
  ```json
  {
      "command": "signout"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signout"
      },
      "status": "ok",
      "content": {}
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "signout"
      },
      "status": "error",
      "content": {
          "detail": "not-signed-in"
      }
  }
  ```

### `subscribe_to_project_events`

- Request:
  ```json
  {
      "command": "subscribe_to_project_events",
      "project": "<project_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_project_events",
          "project": "<project_id>"
      },
      "status": "ok",
      "content": {
          "channel": "projects.<project_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_project_events",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `unsubscribe_from_project_events`

- Request:
  ```json
  {
        "command": "unsubscribe_from_project_events",
        "project": "<project_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_project_events",
          "project": "<project_id>"
      },
      "status": "ok",
      "content": {
          "channel": "projects.<project_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_project_events",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-subscribed"
      }
  }
  ```
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_project_events",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `check_project_events_subscription`

- Request:
  ```json
  {
        "command": "check_project_events_subscription",
        "project": "<project_id>"
  }
  ```
- Response OK:
  ```
  no response send
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "check_project_events_subscription",
          "project": "<project_id>"
      },
      "status": "error",
      "content": {
          "detail": "lost-permissions"
      }
  }
  ```

### `subscribe_to_workspace_events`

- Request:
  ```json
  {
      "command": "subscribe_to_workspace_events",
      "workspace": "<workspace_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "ok",
      "content": {
          "channel": "workspaces.<workspace_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "subscribe_to_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `unsubscribe_from_workspace_events`

- Request:
  ```json
  {
        "command": "unsubscribe_from_workspace_events",
        "workspace": "<workspace_id>"
  }
  ```
- Response OK:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "ok",
      "content": {
          "channel": "workspaces.<workspace_id>"
      }
  }
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-subscribed"
      }
  }
  ```
  ```json
  {
      "type": "action",
      "action": {
          "command": "unsubscribe_from_workspace_events",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "not-allowed"
      }
  }
  ```

### `check_workspace_events_subscription`

- Request:
  ```json
  {
        "command": "check_workspace_events_subscription",
        "workspace": "<workspace_id>"
  }
  ```
- Response OK:
  ```
  no response send
  ```
- Response ERROR:
  ```json
  {
      "type": "action",
      "action": {
          "command": "check_workspace_events_subscription",
          "workspace": "<workspace_id>"
      },
      "status": "error",
      "content": {
          "detail": "lost-permissions"
      }
  }
  ```

## Events

### Response

```json
{
    "type": "event",
    "channel": "<channel-name>",
    "event": {
        "type": "<event-type>",
        "content": {...},
        "correlationId": "<correlation-id value>"
    }
}
```

### Channels

- `system` - channel for brodcast important messages for all the clients. [TODO]
- `users.<username>` - channel to publish all user events.
- `projects.<project_id>` - channel to publish all the project events. [TODO]
- `workspaces.<workspace_id>` - channel to publish all the workspace events. [TODO]


### Types and content schemas

We have common events types for C/U/D actions over the objets, the schema is:

```
<object_in_plural>.["create" | "update" |"delete"]
```

For example:

```
projects.create
projectinvitations.update
userstories.delete
```

We may have other actions if required; for example: `projectinvitations.revoke`.

We may also have events that affect only a subset of atributes of an object; for example `projects.permissions.update`.

We can send actions inside an event. The type must be `action` and the content should be an action described above.


#### **workspaces.delete**

It happens when a workspace is deleted

Content for:
- workspace channel:
  ```
  {
      "workspace": "workspace_id",
      "name": "workspace name (str)",
      "deleted_by": {... basic user info ...}
  }
  ```


#### `workspacememberships.create`

It happens when a workspace invitation is accepted. Because a new workspace membership is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
  }
  ```
- workspace channel:
  ```
  null
  ```

#### **workspacesmemberships.delete**

It happens when a workspace membership is deleted

Content for:
- workspace channel:
  ```
  {
      "membership": {... "workspace membership object" ...}
  }
  ```

- user channel:
  ```
  {
      "membership": {... "workspace membership object" ...}
  }
  ```

#### `workspaceinvitations.create`

It happens when a new workspace invitation is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
  }
  ```

- workspace channel:
  ```
  null
  ```

#### **projects.delete**

It happens when a project is deleted

Content for:
- workspace channel:
  ```
  {
      "project": "project_id",
      "workspace": "workspace_id",
      "name": "project name (str)",
      "deleted_by": {... basic user info ...}
  }
  ```


#### `projectinvitations.create`

It happens when a new project invitation is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectinvitations.update`

It happens when one or more invitations are updated:
- the role has been changed.
- a user has verified her account.


Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectinvitations.revoke`

It happens when one invitation is revoked

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectmemberships.create`

It happens when a project invitation is accepted. Because a new project membership is created.

Content for:
- user channel:
  ```
  {
      "workspace": "workspace_id",
      "project": "project_id"
  }
  ```
- project channel:
  ```
  null
  ```

#### `projectmemberships.update`

It happens when a project membership role is updated.

Content for:
- user channel:
  ```
  {
      "membership": {... "project membership object" ...}
  }
  ```
- project channel:
  ```
  {
      "membership": {... "project membership object" ...}
  }
  ```

#### `projectmemberships.delete`

It happens when a project membership is deleted

Content for:
- user channel:
  ```
  {
      "membership": {... "project membership object" ...},
      "workspace": "workspace_id",
  }
  ```
- project channel:
  ```
  {
      "membership": {... "project membership object" ...},
      "workspace": "workspace_id",
  }
  ```
- workspace channel:
  ```
  {
      "membership": {... "project membership object" ...},
      "workspace": "workspace_id",
  }
  ```


#### `projectroles.update`

It happens when project role (permissions or name) is updated.

Content for:
- project channel:
  ```
  {
      ... "detailed project role object" ...
  }
  ```

#### `projects.permissions.update`

It happens when project public permissions are updated.

Content for:
- project channel:
  ```
  null
  ```


#### `workflowstatuses.create`

It happens when a new workflow status has been created.

Content for:
- project channel:
  ```
  {
      "status": {... "workflow status object" ...}
  }
  ```


#### `stories.create`

It happens when a new story has been created.

Content for:
- project channel:
  ```
  {
      "story": {... "story object" ...}
  }
  ```

#### `stories.update`

It happens when a story has been updated.

Content for:
- project channel:
  ```
  {
      "story": {... "detailed story object" ...}
      "updatesAttrs" : [
          "attr1",
          "attr2",
          ...
      ]
  }
  ```

#### `stories.reorder`

It happens when some stories are reordered.

Content for:
- project channel:
  ```
  {
      "reorder": {
          "status": {... workflow status object ...},
	      "stories": [
		      "moved story ref1 (int)",
		      "moved story ref2 (int)",
              ....
	      ],
	      "reorder": {
		      "place": "'before' or 'after'",
		      "ref": "story ref (int)"
	      }
      }
  }
  ```

#### `stories.delete`

It happens when a story has been deleted.

Content for:
- project channel:
  ```
  {
      "ref": "story ref (int)"
      "deleted_by": {... basic user info ...}
  }
  ```


#### `stories_assignments.create`

It happens when a new story assignment has been created.

Content for:
- user channel:
  ```
  {
      "story_assignment": {... "story_assignment object" ...}
  }
  ```
- project channel:
  ```
  {
      "story_assignment": {... "story_assignment object" ...}
  }
  ```

#### `stories_assignments.delete`

It happens when a story assignment has been deleted.

Content for:
- user channel:
  ```
  {
      "story": {... "story object" ...}
  }
  ```
- project channel:
  ```
  {
      "story": {... "story object" ...}
  }
  ```

